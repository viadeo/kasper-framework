machine:
  services:
   - docker
  environment:
    TERM: dumb
  timezone:
    Europe/Paris
  hosts:
    ## CircleCI AWS SecurityGroup Access
    nexus.viadeobackoffice.com: 10.69.181.179
  java:
    version: oraclejdk8

dependencies:
  cache_directories:
    - "~/.gradle"

  pre:
    # pull shared scripts
    - if [[ ! -d ~/.viadeo ]]; then git clone git@github.com:viadeo/viadeo-docker.git ~/.viadeo; fi
    # provision docker containers
    - ~/.viadeo/bin/docker-provision.sh docker-rabbitmq:latest

  override:
    - ./gradlew --no-daemon compileJava compileTestJava assemble --parallel --max-workers=2:
        timeout: 300

  post:
    # stop f***** services already started
    - sudo /etc/init.d/rabbitmq-server stop && sudo apt-get remove -y rabbitmq-server
    # start docker containers
    - docker run -d -p 5672:5672 -p 15672:15672 quay.io/viadeo/docker-rabbitmq:latest

test:
  override:
    - ./gradlew --no-daemon -a circleCheck --parallel --max-workers=2:
        parallel: true
  post:
      # Delete useless report files that would slow the Collect phase of CircleCi
      - echo "Delete success report"
      - grep -lRL "failure message" $CIRCLE_TEST_REPORTS | xargs rm -f


deployment:
  nexus:
    branch: [develop, prepare_1.0.0]
    owner: viadeo
    commands:
      - ./gradlew --no-daemon -a circleUploadArchives --parallel-threads=2
