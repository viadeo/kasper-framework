<?xml version="1.0"?>
<?xml version="1.0"?>
<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link rel="shortcut icon" href="img/favicon.ico" />
    <title>Kasper</title>
    <style type="text/css">

      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }

      @media (max-width: 980px) {
        .navbar-text.pull-right {
          float: none;
          padding-left: 5px;
          padding-right: 5px;
        }
      }

      .center {
        float: none;
        margin-left: auto;
        margin-right: auto; }
      }

      a.white {color:#FFFFFF;}
      a.white:link {color:#FFFFFF;}
      a.white:visited {color:#FFFFFF;}
      a.white:hover {color:#FFFFFF;}
      a.white:active {color:#FFFFFF;}

    </style>    
    <link href="css/bootstrap-responsive.css" rel="stylesheet">
  </head>
  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a id="brand" class="brand" href="#">Kasper autodoc</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li class="active"><a id="home" href="#">Home</a></li>
              <li><a id="about" href="#about">About</a></li>
              <li><a id="contact" href="#contact">Contact</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span4">     
          <div class="well sidebar-nav">
            <ul class="nav nav-list">
              <li class="nav-header">Domains</li>
              <li>
                <div id="tree_domains"></div>
              </li>
            </ul>
          </div><!--/.well -->
        </div><!--/span-->

        <div id="tree_contents" class="span8">

          <div id="tree_contents_about" class="hero-unit hide">
            <h1>About Kasper autodoc</h1>
            <p></p>
          </div>

          <div id="tree_contents_contact" class="hero-unit hide">
            <h1>Contacts</h1>
            <p>About general Kasper purposes : Viadeo architecture team 
              &lt;<a href="mailto: architecture@viadeoteam.com">architecture@viadeoteam.com</a>&gt;</p>
          </div>

        </div>
      </div><!--/row-->
    </div><!--/fluid-->


    <!-- JAVASCRIPT -->

    <!--script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" ></script-->
    <script src="js/jquery.min.js" ></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.jstree.js"></script>
    <script src="js/handlebars.js"></script>
    <script src="js/raphael-min.js"></script>
    <script src="js/dracula_graffle.js"></script>
    <script src="js/dracula_graph.js"></script>
    <script src="app/switch.js"></script>

    <script>
        $.jstree._themes = "js/jstree_themes/";

        // Wiring

        $('#home, #brand').click(function() {
          $("#tree_contents > div").hide();
          $("#tree_contents_home").show();
        })

        $("#tree_contents_about").hide();
        $('#about').click(function() {
          $("#tree_contents > div").hide();
          $("#tree_contents_about").fadeIn("slow");
        })

        $("#tree_contents_contact").hide();
        $('#contact').click(function() {
          $("#tree_contents > div").hide();
          $("#tree_contents_contact").fadeIn("slow");
        })

        // Let's go !
        $(document).ready(function() {
          
          // Loads the Kasper domains base definition
          $.ajax({
            // FIXME: static var!
            url: "/kasper/doc/domains"
          }).done(function ( data ) {

              if (data.list) {

                var childTypes = [ 
                    ['commands', 'Commands'],
                    ['concepts', 'Concepts'],
                    ['relations', 'Relations'],
                    ['events', 'Events'],
                    ['repositories', 'Repositories'],
                    ['eventListeners', 'Event Listeners'],
                    ['commandHandlers', 'Command Handlers'],
                    ['queryHandlers', 'Query Handlers'],
                    ['queries', 'Queries'],
                    ['queryResults', 'Query Results']
                ];

                $("#tree_domains").append("<ul id='tree_domains_list'></ul>");

                var domain_ids = [];
                var selected_node = [];
                var nodes = {};
                $.each(data.list, function(n, domain) { // Domains
                    var domain_id = 'tree_domain_' + domain.name;
                    var domain_id_list = domain_id + "_list";

                    $("#tree_domains_list").append("<li id='"+domain_id+"'><a href=\"#\">" + domain.label + "</a></li>");
                    $("#"+domain_id).append("<ul id='" + domain_id_list + "'></ul>");
                    $("#"+domain_id).data('node', domain);
                    nodes['#'+domain.name] = domain;

                    domain_ids.push(domain_id);

                    if(window.location.hash.replace("#", "") == domain.name) {
                        selected_node.push(domain_id);
                    }

                    $.each(childTypes, function(n2, childTypeArray) { // Domain sections
                      var childType = childTypeArray[0];                      
                      var childTypeLabel = childTypeArray[1];

                      if (domain[childType].length > 0) {
                        var section_id = "tree_domain_" + domain.name + "_" + childType;
                        var section_id_list = "tree_domain_" + domain.name + "_" + childType + "_list";

                        $("#"+domain_id_list).append("<li id='" + section_id + "'><a href=\"#\">" + childTypeLabel + "</a></li>");
                        $("#"+section_id).append("<ul id='" + section_id_list + "'></ul>");

                        $.each(domain[childType], function(n3, element) { // Domain elements
                          var element_id = "tree_domain_" + domain.name + "_" + element.name;

                          element.domain = domain;
                          element.section = childType;

                          $("#"+section_id_list).append("<li id='" + element_id + "'><a href=\"#\">" + element.label + "</a></li>");
                          $("#"+element_id).data('node', element);
                          nodes['#'+element.name] = element;

                          if(window.location.hash.replace("#", "") == element.name) {
                              selected_node.push(element_id);
                          }
                        });
                      }
                    });
                });

                // Manage with bookmarks
                $('body').on('click', '.klink', function() {
                    var node = nodes[$(this)[0].hash];
                    if (node) {
                      switchNodeContents("tree_contents", node);
                    } else {
                      $("#tree_contents > div").hide();
                      $("#tree_contents_home").show();
                    }
                });

                // Sets default hash if any
                if (window.location.hash && window.location.hash != '#') {
                  var node = nodes[window.location.hash];
                  if (node) {
                    switchNodeContents("tree_contents", node);
                  }
                }

                // Init the domains tree behaviour
                $("#tree_domains").jstree({
                  "plugins" : ["themes","html_data","ui","sort","types"],
                  "ui" : { "initially_select" : [ selected_node ] },
                  "themes" : {
                    "theme" : "apple"
                  },
                  "types" : {
                    "types" : {
                      "default" : {
                        "select_node" : function(node_id) {
                          if (node_id.data("node")) {
                            switchNodeContents("tree_contents", node_id.data("node"));
                            document.location.hash = "#" + node_id.data("node").name;
                          }
                        }
                      }
                    }
                  }
                });

              } // if data list
          }); // ajax
        }); // document ready

    </script>

  </body>
</html>
